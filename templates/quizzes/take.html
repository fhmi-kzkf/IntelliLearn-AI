{% extends 'base.html' %}
{% load quiz_extras %}

{% block title %}{{ quiz.title }} - IntelliLearn AI{% endblock %}

{% block extra_css %}
<style>
    .question-container {
        transition: all 0.3s ease-in-out;
    }
    .choice-option {
        transition: all 0.2s ease;
    }
    .choice-option:hover {
        transform: translateX(4px);
    }
    .progress-bar {
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-intellilearn-black py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Quiz Header -->
        <div class="bg-intellilearn-gray-medium rounded-lg p-6 mb-6 border border-intellilearn-gray-dark">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-intellilearn-white">{{ quiz.title }}</h1>
                    <p class="text-gray-400 mt-1">Question {{ current_question_index|add:1 }} of {{ total_questions }} • {{ current_question.get_difficulty_display }}</p>
                </div>
                <div class="mt-4 lg:mt-0 flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-yellow-400">
                        <i class="fas fa-clock"></i>
                        <span id="timer" class="font-mono text-lg" data-time-limit="{% if time_limit_seconds > 0 %}{{ time_limit_seconds }}{% else %}0{% endif %}">00:00</span>
                    </div>
                    <button type="button" onclick="confirmExit()" class="text-gray-400 hover:text-intellilearn-red transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full bg-intellilearn-gray-dark rounded-full h-3">
                <div class="progress-bar bg-intellilearn-red h-3 rounded-full" style="width: 0%" data-progress="{{ progress_percentage }}"></div>
            </div>
            <div class="flex justify-between text-sm text-gray-400 mt-2">
                <span>Progress</span>
                <span id="progress-text">0% Complete</span>
            </div>
        </div>

        <!-- Question Container -->
        <form method="post" action="{% url 'quizzes:take' quiz_id=quiz.id attempt_id=attempt.id %}?q={{ current_question_index|add:1 }}">
            {% csrf_token %}
            <div class="question-container bg-intellilearn-gray-medium rounded-lg p-8 mb-6 border border-intellilearn-gray-dark">
                <div class="mb-6">
                    <div class="flex items-center space-x-3 mb-4">
                        <span class="bg-intellilearn-red text-white px-3 py-1 rounded-full text-sm font-medium">
                            Question {{ current_question_index|add:1 }}
                        </span>
                        <span class="text-gray-400 text-sm">{{ current_question.get_question_type_display }} • {{ current_question.points }} points</span>
                    </div>
                    
                    <h2 class="text-xl font-semibold text-intellilearn-white leading-relaxed mb-4">
                        {{ current_question.text }}
                    </h2>
                    
                    <!-- Code snippet (optional) -->
                    {% if current_question.code_snippet %}
                    <div class="bg-intellilearn-gray-dark rounded-lg p-4 mb-6 border border-gray-600">
                        <code class="text-green-400 text-sm">
                            {{ current_question.code_snippet|linebreaksbr }}
                        </code>
                    </div>
                    {% endif %}
                </div>

                <!-- Answer Options -->
                <div class="space-y-4">
                    {% if current_question.question_type == 'multiple_choice' %}
                        {% for choice in current_question.choices.all %}
                        <label class="choice-option flex items-center p-4 bg-intellilearn-gray-dark rounded-lg border-2 border-transparent hover:border-intellilearn-red cursor-pointer relative">
                            <input type="radio" name="question_{{ current_question.id }}" value="{{ choice.id }}" class="hidden" {% if user_answer and user_answer.selected_choice.id == choice.id %}checked{% endif %}>
                            <div class="w-8 h-8 border-2 border-gray-400 rounded-full flex items-center justify-center mr-4 choice-indicator 
                                {% if user_answer and user_answer.selected_choice.id == choice.id %}
                                    {% if user_answer.is_correct %}
                                        bg-green-500 border-green-500
                                    {% else %}
                                        bg-red-500 border-red-500
                                    {% endif %}
                                {% else %}
                                    bg-intellilearn-gray-dark border-gray-400
                                {% endif %}">
                                <span class="text-sm font-bold text-intellilearn-white {% if user_answer and user_answer.selected_choice.id == choice.id %}{% else %}hidden{% endif %}">{{ forloop.counter|chr_filter:64 }}</span>
                            </div>
                            <div class="flex-1">
                                <span class="text-intellilearn-white font-medium">{{ choice.text }}</span>
                                {% if choice.explanation %}
                                <p class="text-gray-400 text-sm mt-1">{{ choice.explanation }}</p>
                                {% endif %}
                            </div>
                            {% if user_answer and user_answer.selected_choice.id == choice.id %}
                                {% if user_answer.is_correct %}
                                    <div class="absolute top-2 right-2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                {% else %}
                                    <div class="absolute top-2 right-2 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-times text-white text-xs"></i>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </label>
                        {% endfor %}
                    {% elif current_question.question_type == 'true_false' %}
                        <label class="choice-option flex items-center p-4 bg-intellilearn-gray-dark rounded-lg border-2 border-transparent hover:border-intellilearn-red cursor-pointer relative">
                            <input type="radio" name="question_{{ current_question.id }}" value="True" class="hidden" {% if user_answer and user_answer.text_answer == 'True' %}checked{% endif %}>
                            <div class="w-8 h-8 border-2 border-gray-400 rounded-full flex items-center justify-center mr-4 choice-indicator 
                                {% if user_answer and user_answer.text_answer == 'True' %}
                                    {% if user_answer.is_correct %}
                                        bg-green-500 border-green-500
                                    {% else %}
                                        bg-red-500 border-red-500
                                    {% endif %}
                                {% else %}
                                    bg-intellilearn-gray-dark border-gray-400
                                {% endif %}">
                                <span class="text-sm font-bold text-intellilearn-white {% if user_answer and user_answer.text_answer == 'True' %}{% else %}hidden{% endif %}">T</span>
                            </div>
                            <div class="flex-1">
                                <span class="text-intellilearn-white font-medium">True</span>
                            </div>
                            {% if user_answer and user_answer.text_answer == 'True' %}
                                {% if user_answer.is_correct %}
                                    <div class="absolute top-2 right-2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                {% else %}
                                    <div class="absolute top-2 right-2 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-times text-white text-xs"></i>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </label>
                        <label class="choice-option flex items-center p-4 bg-intellilearn-gray-dark rounded-lg border-2 border-transparent hover:border-intellilearn-red cursor-pointer relative">
                            <input type="radio" name="question_{{ current_question.id }}" value="False" class="hidden" {% if user_answer and user_answer.text_answer == 'False' %}checked{% endif %}>
                            <div class="w-8 h-8 border-2 border-gray-400 rounded-full flex items-center justify-center mr-4 choice-indicator 
                                {% if user_answer and user_answer.text_answer == 'False' %}
                                    {% if user_answer.is_correct %}
                                        bg-green-500 border-green-500
                                    {% else %}
                                        bg-red-500 border-red-500
                                    {% endif %}
                                {% else %}
                                    bg-intellilearn-gray-dark border-gray-400
                                {% endif %}">
                                <span class="text-sm font-bold text-intellilearn-white {% if user_answer and user_answer.text_answer == 'False' %}{% else %}hidden{% endif %}">F</span>
                            </div>
                            <div class="flex-1">
                                <span class="text-intellilearn-white font-medium">False</span>
                            </div>
                            {% if user_answer and user_answer.text_answer == 'False' %}
                                {% if user_answer.is_correct %}
                                    <div class="absolute top-2 right-2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                {% else %}
                                    <div class="absolute top-2 right-2 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-times text-white text-xs"></i>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </label>
                    {% elif current_question.question_type == 'fill_blank' %}
                        <div class="p-4 bg-intellilearn-gray-dark rounded-lg border border-gray-600">
                            <input type="text" name="question_{{ current_question.id }}" value="{{ user_answer.text_answer|default:'' }}" placeholder="Enter your answer..." class="w-full bg-intellilearn-black text-intellilearn-white px-4 py-2 rounded border border-gray-600 focus:border-intellilearn-red focus:outline-none">
                        </div>
                        {% if user_answer and user_answer.text_answer %}
                            <div class="mt-2 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                                <p class="text-blue-300 text-sm">Your answer: {{ user_answer.text_answer }}</p>
                                {% if user_answer.is_correct %}
                                    <p class="text-green-400 text-sm mt-1"><i class="fas fa-check mr-1"></i>Correct!</p>
                                {% else %}
                                    <p class="text-red-400 text-sm mt-1"><i class="fas fa-times mr-1"></i>Incorrect</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% elif current_question.question_type == 'short_answer' %}
                        <div class="p-4 bg-intellilearn-gray-dark rounded-lg border border-gray-600">
                            <textarea name="question_{{ current_question.id }}" rows="4" placeholder="Enter your detailed answer..." class="w-full bg-intellilearn-black text-intellilearn-white px-4 py-2 rounded border border-gray-600 focus:border-intellilearn-red focus:outline-none">{{ user_answer.text_answer|default:'' }}</textarea>
                        </div>
                        {% if user_answer and user_answer.text_answer %}
                            <div class="mt-2 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                                <p class="text-blue-300 text-sm">Your answer: {{ user_answer.text_answer }}</p>
                                {% if user_answer.is_correct %}
                                    <p class="text-green-400 text-sm mt-1"><i class="fas fa-check mr-1"></i>Correct!</p>
                                {% else %}
                                    <p class="text-red-400 text-sm mt-1"><i class="fas fa-times mr-1"></i>Incorrect</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% elif current_question.question_type == 'code_completion' %}
                        <div class="p-4 bg-intellilearn-gray-dark rounded-lg border border-gray-600">
                            <textarea name="question_{{ current_question.id }}" rows="6" placeholder="Write your code solution..." class="w-full bg-intellilearn-black text-green-400 font-mono px-4 py-2 rounded border border-gray-600 focus:border-intellilearn-red focus:outline-none">{{ user_answer.text_answer|default:'' }}</textarea>
                        </div>
                        {% if user_answer and user_answer.text_answer %}
                            <div class="mt-2 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                                <p class="text-blue-300 text-sm">Your answer: {{ user_answer.text_answer }}</p>
                                {% if user_answer.is_correct %}
                                    <p class="text-green-400 text-sm mt-1"><i class="fas fa-check mr-1"></i>Correct!</p>
                                {% else %}
                                    <p class="text-red-400 text-sm mt-1"><i class="fas fa-times mr-1"></i>Incorrect</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- AI Hint (optional) -->
                {% if current_question.explanation %}
                <div id="ai-hint" class="mt-6 bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 hidden">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div>
                            <h4 class="text-blue-300 font-medium mb-2">Explanation</h4>
                            <p class="text-blue-100 text-sm">
                                {{ current_question.explanation }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Navigation -->
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-4">
                    {% if current_question_index > 0 %}
                    <a href="?q={{ current_question_index }}" class="flex items-center px-6 py-3 bg-intellilearn-gray-medium text-intellilearn-white rounded-lg hover:bg-intellilearn-gray-dark transition-colors border border-intellilearn-gray-dark">
                        <i class="fas fa-chevron-left mr-2"></i>Previous
                    </a>
                    {% else %}
                    <button type="button" class="flex items-center px-6 py-3 bg-intellilearn-gray-medium text-gray-500 rounded-lg border border-intellilearn-gray-dark cursor-not-allowed" disabled>
                        <i class="fas fa-chevron-left mr-2"></i>Previous
                    </button>
                    {% endif %}
                    
                    {% if current_question.explanation %}
                    <button type="button" onclick="toggleHint()" class="flex items-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-lightbulb mr-2"></i>Get Hint
                    </button>
                    {% endif %}
                </div>

                <div class="flex items-center space-x-4">
                    <button type="button" onclick="flagQuestion()" class="flex items-center px-4 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                        <i class="fas fa-flag mr-2"></i>Flag
                    </button>
                    
                    <button type="submit" class="flex items-center px-6 py-3 bg-intellilearn-red text-white rounded-lg hover:bg-red-600 transition-colors font-medium">
                        {% if current_question_index < total_questions|add:-1 %}
                            Save & Next<i class="fas fa-chevron-right ml-2"></i>
                        {% else %}
                            Save & Review<i class="fas fa-check ml-2"></i>
                        {% endif %}
                    </button>
                </div>
            </div>
        </form>

        <!-- Question Navigation Panel -->
        <div class="mt-8 bg-intellilearn-gray-medium rounded-lg p-6 border border-intellilearn-gray-dark">
            <h3 class="text-lg font-semibold text-intellilearn-white mb-4">Question Overview</h3>
            <div class="grid grid-cols-5 sm:grid-cols-10 gap-2">
                <!-- Question buttons -->
                {% for question in questions %}
                <a href="?q={{ forloop.counter }}" class="w-10 h-10 {% if forloop.counter0 == current_question_index %}bg-intellilearn-red{% elif forloop.counter0 < current_question_index %}bg-green-600{% else %}bg-intellilearn-gray-dark{% endif %} text-white rounded-lg text-sm font-medium hover:bg-opacity-80 transition-colors flex items-center justify-center">
                    {{ forloop.counter }}
                </a>
                {% endfor %}
            </div>
            <div class="flex items-center space-x-6 mt-4 text-sm">
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-green-600 rounded"></div>
                    <span class="text-gray-300">Answered</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-intellilearn-red rounded"></div>
                    <span class="text-gray-300">Current</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-yellow-600 rounded"></div>
                    <span class="text-gray-300">Flagged</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-intellilearn-gray-dark rounded"></div>
                    <span class="text-gray-300">Not Answered</span>
                </div>
            </div>
        </div>

        <!-- Submit Quiz Button -->
        <div class="text-center mt-8">
            <button type="button" onclick="confirmSubmit()" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium text-lg">
                <i class="fas fa-check mr-2"></i>Submit Quiz
            </button>
        </div>
    </div>
</div>

<!-- Confirmation Modals -->
<div id="exit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-intellilearn-gray-medium rounded-lg p-6 max-w-md mx-4 border border-intellilearn-gray-dark">
        <h3 class="text-xl font-semibold text-intellilearn-white mb-4">Exit Quiz?</h3>
        <p class="text-gray-300 mb-6">Your progress will be saved, but you'll need to restart from where you left off.</p>
        <div class="flex space-x-4">
            <button type="button" onclick="closeModal('exit-modal')" class="flex-1 bg-intellilearn-gray-dark text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">Cancel</button>
            <a href="{% url 'quizzes:list' %}" class="flex-1 bg-intellilearn-red text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Exit Quiz</a>
        </div>
    </div>
</div>

<div id="submit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-intellilearn-gray-medium rounded-lg p-6 max-w-md mx-4 border border-intellilearn-gray-dark">
        <h3 class="text-xl font-semibold text-intellilearn-white mb-4">Submit Quiz?</h3>
        <p class="text-gray-300 mb-6">Once submitted, you cannot change your answers.</p>
        <form method="post" action="{% url 'quizzes:submit' quiz_id=quiz.id attempt_id=attempt.id %}">
            {% csrf_token %}
            <div class="flex space-x-4">
                <button type="button" onclick="closeModal('submit-modal')" class="flex-1 bg-intellilearn-gray-dark text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">Review Answers</button>
                <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">Submit</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set progress bar and timer values
    document.addEventListener('DOMContentLoaded', function() {
        // Set progress bar
        const progressBar = document.querySelector('.progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressPercentage = parseFloat(progressBar.getAttribute('data-progress') || '0');
        progressBar.style.width = progressPercentage + '%';
        progressText.textContent = Math.round(progressPercentage) + '% Complete';
        
        // Set timer
        const timerElement = document.getElementById('timer');
        const timeLimit = parseInt(timerElement.getAttribute('data-time-limit') || '0');
        let timeLeft = timeLimit;
        
        function updateTimer() {
            if (timeLeft <= 0) {
                // Time expired, auto-submit
                const submitForm = document.querySelector('form[action*="submit"]');
                if (submitForm) {
                    submitForm.submit();
                }
                return;
            }
            
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            timeLeft--;
        }
        
        if (timeLimit > 0) {
            updateTimer(); // Initial update
            setInterval(updateTimer, 1000);
        } else {
            timerElement.textContent = 'No Limit';
        }
        
        // Choice selection with immediate feedback
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Reset all choice indicators
                document.querySelectorAll('.choice-indicator').forEach(indicator => {
                    // Only reset indicators that are not already marked as correct/incorrect
                    if (!indicator.classList.contains('bg-green-500') && !indicator.classList.contains('bg-red-500')) {
                        indicator.classList.remove('bg-intellilearn-red', 'border-intellilearn-red');
                        indicator.classList.add('border-gray-400');
                        indicator.querySelector('span').classList.add('hidden');
                    }
                });
                
                // Highlight selected choice
                const choiceIndicator = this.parentElement.querySelector('.choice-indicator');
                // Only update if not already marked as correct/incorrect
                if (!choiceIndicator.classList.contains('bg-green-500') && !choiceIndicator.classList.contains('bg-red-500')) {
                    choiceIndicator.classList.add('bg-intellilearn-red', 'border-intellilearn-red');
                    choiceIndicator.classList.remove('border-gray-400');
                    choiceIndicator.querySelector('span').classList.remove('hidden');
                }
                
                // Auto-submit the form for immediate feedback
                this.form.submit();
            });
        });
        
        // Navigation functions
        function toggleHint() {
            const hint = document.getElementById('ai-hint');
            hint.classList.toggle('hidden');
        }
        
        function flagQuestion() {
            // Implementation for flagging question
            console.log('Question flagged');
        }
        
        function confirmExit() {
            document.getElementById('exit-modal').classList.remove('hidden');
        }
        
        function confirmSubmit() {
            document.getElementById('submit-modal').classList.remove('hidden');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // Auto-save functionality
        function autoSave() {
            // Save current answers to localStorage or send to server
            console.log('Auto-saving progress...');
        }
        
        setInterval(autoSave, 30000); // Auto-save every 30 seconds
    });
</script>
{% endblock %}
</html>